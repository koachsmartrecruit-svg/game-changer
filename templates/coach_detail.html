{% extends "base.html" %}
{% block content %}

<div class="container coach-detail-page py-4 py-lg-5">

  <div class="row g-4 mb-4 align-items-center">

    <div class="col-md-3 text-center text-md-start">
      {% set display_name = coach.name %}

      <div class="coach-detail-avatar mb-3">
        {% if coach.profile_image %}
          <img
            src="{{ url_for('static', filename='uploads/' + coach.profile_image) }}"
            alt="{{ display_name }}"
            class="coach-detail-avatar-img">
        {% else %}
          <div class="coach-detail-avatar-fallback">
            <span>{{ display_name[0].upper() }}</span>
          </div>
        {% endif %}
      </div>

      {% if coach.is_verified %}
        <span class="badge bg-success">Verified Pro</span>
      {% else %}
        <span class="badge bg-warning text-dark">Unverified</span>
      {% endif %}
    </div>

    <div class="col-md-6">
      <h1 class="h3">{{ coach.name }}</h1>
      <p class="text-muted">{{ coach.tagline }}</p>

      <div class="mb-2">
        ‚≠ê {{ coach.rating or 0 }} | {{ coach.experience_years }} yrs experience | Age {{ coach.age }}
      </div>

      <div class="text-muted mb-2">
        üìç {{ coach.city }}, {{ coach.state }}
      </div>

      {% for sport in coach.get_sports_list() %}
        <span class="badge bg-primary">{{ sport }}</span>
      {% endfor %}
    </div>

    <div class="col-md-3 text-center text-md-end">
      {% set prices = coach.get_price_dict() %}
      {% if prices %}
        <h4>‚Çπ{{ prices.values()|list|min }} / session</h4>
      {% else %}
        <p>Contact for price</p>
      {% endif %}

      {% if coach.is_paid() and coach.phone %}
        <a href="{{ coach.get_whatsapp_url() }}"
           target="_blank"
           class="btn btn-success w-100 rounded-pill mb-2 mt-2">
          <i class="bi bi-whatsapp me-1"></i> Chat on WhatsApp
        </a>
      {% endif %}

      {% if coach.is_paid() %}
        <div class="d-flex justify-content-center gap-2 mt-2">

          {% if coach.instagram_url %}
            <a href="{{ coach.instagram_url }}" target="_blank"
               class="btn btn-outline-danger btn-sm rounded-pill">
              <i class="bi bi-instagram"></i>
            </a>
          {% endif %}

          {% if coach.youtube_url %}
            <a href="{{ coach.youtube_url }}" target="_blank"
               class="btn btn-outline-danger btn-sm rounded-pill">
              <i class="bi bi-youtube"></i>
            </a>
          {% endif %}

          {% if coach.linkedin_url %}
            <a href="{{ coach.linkedin_url }}" target="_blank"
               class="btn btn-outline-primary btn-sm rounded-pill">
              <i class="bi bi-linkedin"></i>
            </a>
          {% endif %}

          {% if coach.website_url %}
            <a href="{{ coach.website_url }}" target="_blank"
               class="btn btn-outline-dark btn-sm rounded-pill">
              <i class="bi bi-globe"></i>
            </a>
          {% endif %}

        </div>
      {% endif %}
    </div>
  </div>

  <form method="POST"
        action="{{ url_for('book_session', coach_id=coach.id) }}"
        id="booking">

    <input type="hidden" name="sport" value="{{ coach.get_sports_list()[0] }}">

    <div class="row mt-4">
      <div class="col-md-6">

        <label class="fw-bold mb-2">Training Location</label>

        <div class="form-check">
          <input class="form-check-input"
                 type="radio"
                 name="venue_type"
                 value="coach_venue"
                 checked
                 onclick="toggleVenueSelect(true)">
          <label class="form-check-label">
            Coach‚Äôs Training Venue
          </label>
        </div>

        <div class="form-check mb-2">
          <input class="form-check-input"
                 type="radio"
                 name="venue_type"
                 value="student_home"
                 onclick="toggleVenueSelect(false)">
          <label class="form-check-label">
            Coach comes to my home
          </label>
        </div>

        <div id="coachVenueBox" class="mb-3">
          <label class="fw-bold">Select Venue</label>
          <select name="venue_id" class="form-select">
            {% for v in coach.venues %}
              <option value="{{ v.id }}">
                {{ v.name }} ‚Äì {{ v.address }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div id="studentAddressBox" class="mb-3 d-none">
          <label class="fw-bold">Your Address</label>
          <textarea name="student_address"
                    class="form-control"
                    rows="3"
                    placeholder="House no, area, landmark, pincode"></textarea>
        </div>
        <div class="mb-3">
          <label class="fw-bold">Select Date</label>
          <input type="date"
                 name="date"
                 id="bookingDate"
                 class="form-control"
                 required>
        </div>

        <div class="mb-3">
          <label class="fw-bold">Select Time</label>
          <select name="time"
                  id="timeSlotSelect"
                  class="form-select"
                  required>
            <option value="">Select date first</option>
          </select>
        </div>

        <div class="mb-4">
          <label class="fw-bold">Message (optional)</label>
          <textarea name="message"
                    class="form-control"
                    rows="3"
                    placeholder="Any goals or notes for the coach?"></textarea>
        </div>

        {% if coach.completion_score() < 70 %}
          <div class="alert alert-warning mt-3">
            üöß Coach profile is being completed. Bookings temporarily unavailable.
          </div>
        {% else %}
          <button type="submit"
                  class="btn btn-primary btn-lg rounded-pill px-5">
            Confirm Booking Request
          </button>
        {% endif %}

      </div>
    </div>

  </form>
</div>

<script>

function toggleVenueSelect(isCoachVenue) {
  document.getElementById("coachVenueBox")
    .classList.toggle("d-none", !isCoachVenue);

  document.getElementById("studentAddressBox")
    .classList.toggle("d-none", isCoachVenue);
}



const dateInput = document.getElementById("bookingDate");
const timeSelect = document.getElementById("timeSlotSelect");

dateInput.addEventListener("change", async () => {
  const date = dateInput.value;
  timeSelect.innerHTML = "<option>Loading slots...</option>";

  if (!date) return;

  try {
    const res = await fetch(`/api/coach/{{ coach.id }}/slots?date=${date}`);
    const data = await res.json();

    timeSelect.innerHTML = "";

    if (!data.slots || data.slots.length === 0) {
      timeSelect.innerHTML =
        "<option value=''>No slots available</option>";
      return;
    }

    timeSelect.innerHTML =
      "<option value=''>Select a time</option>";

    data.slots.forEach(slot => {
      const opt = document.createElement("option");
      opt.value = slot;
      opt.textContent = slot;
      timeSelect.appendChild(opt);
    });

  } catch (e) {
    console.error(e);
    timeSelect.innerHTML =
      "<option value=''>Error loading slots</option>";
  }
});
</script>

{% endblock %}
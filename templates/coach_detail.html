{% extends "base.html" %}
{% block content %}

<div class="container coach-detail-page py-4 py-lg-5">

  <!-- ================= TOP SECTION ================= -->
  <div class="row g-4 mb-4 align-items-center">

    <!-- LEFT: Avatar -->
    <div class="col-md-3 text-center text-md-start">
      {% set display_name = coach.name %}

      <div class="coach-detail-avatar mb-3">
        {% if coach.profile_image %}
          <img
            src="{{ url_for('static', filename='uploads/' + coach.profile_image) }}"
            alt="{{ display_name }}"
            class="coach-detail-avatar-img">
        {% else %}
          <div class="coach-detail-avatar-fallback">
            <span>{{ display_name[0].upper() }}</span>
          </div>
        {% endif %}
      </div>

      {% if coach.is_verified %}
        <span class="badge bg-success">Verified Pro</span>
      {% else %}
        <span class="badge bg-warning text-dark">Unverified</span>
      {% endif %}
    </div>

    <!-- CENTER -->
    <div class="col-md-6">
      <h1 class="h3">{{ coach.name }}</h1>
      <p class="text-muted">{{ coach.tagline }}</p>

      <div class="mb-2">
        ‚≠ê {{ coach.rating or 0 }} | {{ coach.experience_years }} yrs experience | Age {{ coach.age }}
      </div>

      <div class="text-muted mb-2">
        üìç {{ coach.city }}, {{ coach.state }}
      </div>

      {% for sport in coach.get_sports_list() %}
        <span class="badge bg-primary">{{ sport }}</span>
      {% endfor %}
    </div>

    <!-- RIGHT -->
    <div class="col-md-3 text-center text-md-end">
      {% set prices = coach.get_price_dict() %}
      {% if prices %}
        <h4>‚Çπ{{ prices.values()|list|min }} / session</h4>
      {% else %}
        <p>Contact for price</p>
      {% endif %}
    </div>
  </div>

  <!-- ================= BOOKING FORM ================= -->
  <form method="POST"
        action="{{ url_for('book_session', coach_id=coach.id) }}"
        id="booking">

    <!-- REQUIRED SPORT (backend needs this) -->
    <input type="hidden" name="sport" value="{{ coach.get_sports_list()[0] }}">

    <div class="row mt-4">
      <div class="col-md-6">

        <!-- ===== Venue Selection ===== -->
        <label class="fw-bold mb-2">Training Location</label>

        <div class="form-check">
          <input class="form-check-input"
                 type="radio"
                 name="venue_type"
                 value="coach_venue"
                 checked
                 onclick="toggleAddress(false)">
          <label class="form-check-label">Coach‚Äôs Training Venue</label>
        </div>

        <div class="form-check mb-3">
          <input class="form-check-input"
                 type="radio"
                 name="venue_type"
                 value="student_home"
                 onclick="toggleAddress(true)">
          <label class="form-check-label">Coach comes to my home</label>
        </div>

        <!-- Student Address -->
        <div id="studentAddressBox" class="mb-3 d-none">
          <label class="fw-bold">Your Address</label>
          <textarea name="student_address"
                    class="form-control"
                    rows="3"
                    placeholder="House no, area, landmark, pincode"></textarea>
        </div>

        <!-- ===== Date Picker ===== -->
        <div class="mb-3">
          <label class="fw-bold">Select Date</label>
          <input type="date"
                 name="date"
                 id="bookingDate"
                 class="form-control"
                 required>
        </div>

        <!-- ===== Time Slots ===== -->
        <div class="mb-3">
          <label class="fw-bold">Select Time</label>
          <select name="time"
                  id="timeSlotSelect"
                  class="form-select"
                  required>
            <option value="">Select date first</option>
          </select>
        </div>

        <!-- ===== Message ===== -->
        <div class="mb-4">
          <label class="fw-bold">Message (optional)</label>
          <textarea name="message"
                    class="form-control"
                    rows="3"
                    placeholder="Any goals or notes for the coach?"></textarea>
        </div>

        <!-- ===== Submit ===== -->
        <button type="submit"
                class="btn btn-primary btn-lg rounded-pill px-5">
          Confirm Booking Request
        </button>

      </div>
    </div>

  </form>
</div>

<!-- ================= JS ================= -->
<script>
function toggleAddress(show) {
  document.getElementById("studentAddressBox")
    .classList.toggle("d-none", !show);
}

const dateInput = document.getElementById("bookingDate");
const timeSelect = document.getElementById("timeSlotSelect");

dateInput.addEventListener("change", async () => {
  const date = dateInput.value;
  timeSelect.innerHTML = "<option>Loading slots...</option>";

  if (!date) return;

  try {
    const res = await fetch(`/api/coach/{{ coach.id }}/slots?date=${date}`);
    const data = await res.json();

    timeSelect.innerHTML = "";

    if (!data.slots || data.slots.length === 0) {
      timeSelect.innerHTML =
        "<option value=''>No slots available</option>";
      return;
    }

    timeSelect.innerHTML =
      "<option value=''>Select a time</option>";

    data.slots.forEach(slot => {
      const opt = document.createElement("option");
      opt.value = slot;
      opt.textContent = slot;
      timeSelect.appendChild(opt);
    });

  } catch (e) {
    console.error(e);
    timeSelect.innerHTML =
      "<option value=''>Error loading slots</option>";
  }
});
</script>

{% endblock %}
